{"entries":[{"timestamp":1762489362256,"editorVersion":"8.0.18","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":979,"diffs":[[1,"<xml xmlns=\"http://www.w3.org/1999/xhtml\">\n  <block type=\"pxt-on-start\"></block>\n  <block type=\"device_forever\"></block>\n</xml>"]]}]},{"type":"edited","filename":"main.ts","patch":[{"start1":0,"length1":168,"diffs":[[1,"\n"]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":204,"length1":38,"diffs":[[1,"        \"README.md\"\n"]]},{"start1":231,"length1":79,"diffs":[[1,"    \"additionalFilePaths\": []\n"]]}]},{"type":"added","filename":"test.ts","value":"// tests go here; this will not be compiled when this package is used as an extension.\n"},{"type":"added","filename":"dht.ts","value":"//% icon=\"\\uf043\" color=190\nnamespace DHT20 {\n    class SoftI2C {\n        scl: number\n        sda: number\n        delay: number\n        constructor(scl: number, sda: number, delay: number = 2) {\n            this.scl = scl\n            this.sda = sda\n            this.delay = delay\n            pins.digitalWritePin(scl, 1)\n            pins.digitalWritePin(this.sda, 1)\n        }\n\n        private _clock() {\n            control.waitMicros(this.delay * 1e3)\n            pins.digitalWritePin(this.scl, 1)\n            control.waitMicros(this.delay * 1e3)\n            pins.digitalWritePin(this.scl, 0)\n        }\n\n        public start() {\n            pins.digitalWritePin(this.sda, 1)\n            pins.digitalWritePin(this.scl, 1)\n            control.waitMicros(this.delay * 1e3)\n            pins.digitalWritePin(this.sda, 0)\n            control.waitMicros(this.delay * 1e3)\n            pins.digitalWritePin(this.scl, 0)\n        }\n\n        public stop() {\n            pins.digitalWritePin(this.sda, 0)\n            pins.digitalWritePin(this.scl, 1)\n            control.waitMicros(this.delay * 1e3)\n            pins.digitalWritePin(this.sda, 1)\n            control.waitMicros(this.delay * 1e3)\n        }\n\n        public write_byte(b: number) {\n            for (let i = 0; i < 8; i++) {\n                pins.digitalWritePin(this.sda, b >> 7 - i & 1)\n                this._clock()\n            }\n            pins.digitalWritePin(this.sda, 1)\n            control.waitMicros(this.delay * 1e3)\n            pins.digitalWritePin(this.scl, 1)\n            let ack = pins.digitalReadPin(this.sda)\n            pins.digitalWritePin(this.scl, 0)\n            return ack == 0\n        }\n\n        public read_byte(ack: boolean = true): number {\n            let value = 0\n            pins.digitalWritePin(this.sda, 1)\n            for (let j = 0; j < 8; j++) {\n                pins.digitalWritePin(this.scl, 1)\n                control.waitMicros(this.delay * 1e3)\n                value = value << 1 | pins.digitalReadPin(this.sda)\n                pins.digitalWritePin(this.scl, 0)\n                control.waitMicros(this.delay * 1e3)\n            }\n            pins.digitalWritePin(this.sda, ack ? 0 : 1)\n            this._clock()\n            pins.digitalWritePin(this.sda, 1)\n            return value\n        }\n\n    }\n\n    class DHT20 {\n        static ADDRESS: number\n        private ___ADDRESS_is_set: boolean\n        private ___ADDRESS: number\n        get ADDRESS(): number {\n            return this.___ADDRESS_is_set ? this.___ADDRESS : DHT20.ADDRESS\n        }\n        set ADDRESS(value: number) {\n            this.___ADDRESS_is_set = true\n            this.___ADDRESS = value\n        }\n\n        i2c: SoftI2C\n        public static __initDHT20() {\n            DHT20.ADDRESS = 0x38\n        }\n\n        constructor(i2c: SoftI2C) {\n            this.i2c = i2c\n            this._init_sensor()\n        }\n\n        private _init_sensor() {\n            this._write([0xBE, 0x08, 0x00])\n            control.waitMicros(5e4)\n        }\n\n        private _write(data: number[]) {\n            this.i2c.start()\n            this.i2c.write_byte(this.ADDRESS << 1)\n            for (let b of data) {\n                this.i2c.write_byte(b)\n            }\n            this.i2c.stop()\n        }\n\n        private _read(n: number): number[] {\n            let data = []\n            this.i2c.start()\n            this.i2c.write_byte(this.ADDRESS << 1 | 1)\n            for (let k = 0; k < n; k++) {\n                data.push(this.i2c.read_byte(k < n - 1))\n            }\n            this.i2c.stop()\n            return data\n        }\n\n        public read(): number[] {\n            this._write([0xAC, 0x33, 0x00])\n            control.waitMicros(8e4)\n            let data2 = this._read(7)\n            if ((data2[0] & 0x80) != 0) {\n                return [null, null]\n            }\n\n            let raw_h = data2[1] << 12 | data2[2] << 4 | data2[3] >> 4\n            let raw_t = (data2[3] & 0x0F) << 16 | data2[4] << 8 | data2[5]\n            let humidity = raw_h / 2 ** 20 * 100\n            let temperature = raw_t / 2 ** 20 * 200 - 50\n            return [humidity, temperature]\n        }\n\n    }\n\n    export let dht_humidity: number = null;\n    export let dht_temperature: number = null;\n\n    //% block=\"humidity\"\n    export function getHumidity(): number {\n        return dht_humidity\n    }\n\n    //% block=\"temperature\"\n    export function getTemp(): number {\n        return dht_temperature\n    }\n\n    let sensor: DHT20 = null;\n\n    //** Start the connection to the DHT. */\n    //% block=\"initialize dht | using SCL pin $scl_pin and SDA pin $sda_pin\"\n    export function initializeDht(scl_pin: DigitalPin, sda_pin: DigitalPin) {\n        DHT20.__initDHT20()\n\n\n        //  --- Setup Soft I2C and Sensor ---\n        let i2c = new SoftI2C(scl_pin, sda_pin)\n        sensor = new DHT20(i2c)\n    }\n\n    //** Update the humidity and temperature readings from the sensor. You must use \"initialize dht\" first.*/\n    //% block\n    export function readDht() {\n        [dht_humidity, dht_temperature] = sensor.read()\n        if (dht_humidity !== null) {\n            console.log(\"Humidity: \" + (\"\" + Math.roundWithPrecision(dht_humidity, 1)) + \" %, temp: \" + (\"\" + Math.roundWithPrecision(dht_temperature, 1)) + \"C\")\n        }\n\n        control.waitMicros(1e6)\n    }\n}\n"}]}],"snapshots":[{"timestamp":1762489362255,"editorVersion":"8.0.18","text":{"main.blocks":"<xml xmlns=\"http://www.w3.org/1999/xhtml\">\n  <block type=\"pxt-on-start\"></block>\n  <block type=\"device_forever\"></block>\n</xml>","main.ts":"\n","README.md":"","pxt.json":"{\n    \"name\": \"DHT20 v4\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"radio\": \"*\",\n        \"microphone\": \"*\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\"\n    ],\n    \"additionalFilePaths\": []\n}\n"}}],"shares":[],"lastSaveTime":1762489586692}